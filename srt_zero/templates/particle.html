{% extends "base.html" %}

{% block title %}{{ particle.name }} - SRT Catalog{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <a href="/" style="color: var(--text-secondary); font-size: 0.9rem;">← Back to Catalog</a>
</div>

<div class="card"
    style="margin-bottom: 2rem; background: linear-gradient(180deg, rgba(20, 20, 25, 0.8) 0%, rgba(10, 10, 15, 0.9) 100%);">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 0.5rem;">
                <h1 style="margin: 0; font-size: 3rem;">{{ particle.name }}</h1>
                <span class="text-mono text-accent" style="font-size: 2rem;">{{ particle.symbol }}</span>
            </div>
            <div class="badge badge-type">{{ particle.particle_type.name }}</div>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 0.9rem; color: var(--text-secondary);">PDG Experimental Value</div>
            <div class="text-mono" style="font-size: 1.5rem;">{{ particle.pdg_value }} {{ particle.pdg_unit }}</div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">± {{ particle.pdg_uncertainty }}</div>
        </div>
    </div>

    <div class="formula-display text-mono">
        {% if particle.notes %}
        {{ particle.notes }}
        {% else %}
        Formula not available in notes
        {% endif %}
    </div>
</div>

{% if derivation %}
<div class="grid" style="grid-template-columns: 2fr 1fr;">
    <div>
        <h2>Derivation Path</h2>
        <div class="derivation-path">
            <!-- Tree Level -->
            <div class="step tree">
                <h3 class="text-accent">Tree Level</h3>
                <div class="text-mono" style="font-size: 1.2rem; margin-bottom: 0.5rem;">
                    {{ "%.6f"|format(derivation.tree_value) }}
                </div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                    Base Geometric Value (E* × N)
                </div>
            </div>

            <!-- Corrections -->
            {% for step in derivation.steps %}
            <div class="step">
                <div style="display: flex; justify-content: space-between;">
                    <h4 style="margin: 0;">{{ step.description }}</h4>
                    <span class="badge">{{ step.step_type }}</span>
                </div>
                <div class="text-mono" style="color: var(--text-secondary); margin: 0.5rem 0;">
                    × {{ "%.8f"|format(step.factor) }}
                </div>
                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                    Result: <span class="text-mono" style="color: #fff;">{{ "%.6f"|format(step.after) }}</span>
                </div>
            </div>
            {% endfor %}

            <!-- Final -->
            <div class="step final">
                <h3 class="text-gold">Final Prediction</h3>
                <div class="text-mono text-gold" style="font-size: 2rem;">
                    {{ "%.8f"|format(derivation.final_value) }}
                </div>
            </div>
        </div>
    </div>

    <div>
        <div class="card" style="position: sticky; top: 2rem;">
            <h3>Precision Analysis</h3>

            <div class="value-comparison" style="flex-direction: column; gap: 1.5rem; margin-top: 1rem;">
                <div>
                    <div class="value-label">Predicted Value</div>
                    <div class="value-number text-gold">{{ "%.6f"|format(derivation.final_value) }}</div>
                </div>

                <div>
                    <div class="value-label">Experimental Value</div>
                    <div class="value-number">{{ particle.pdg_value }}</div>
                </div>

                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                    <div class="value-label">Deviation</div>
                    <div class="value-number deviation {{ 'good' if derivation.deviation_percent < 0.01 else 'warn' }}">
                        {{ "%.6f"|format(derivation.deviation_percent) }}%
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Target: < 0.0001% </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card">
        <h3 style="color: #ff5555;">Calculation Not Available</h3>
        <p>The automated derivation logic for this particle type ({{ particle.formula_type.name }}) is not yet fully
            implemented in the web view.</p>
    </div>
    {% endif %}

    {% endblock %}